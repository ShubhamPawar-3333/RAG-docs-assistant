# GitHub Actions CI Pipeline
# Runs tests and evaluation on pull requests

name: CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  PYTHON_VERSION: "3.11"
  NODE_VERSION: "20"

jobs:
  # ============== Lint & Type Check ==============
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff mypy
          pip install -r requirements.txt
      
      - name: Run Ruff linter
        run: ruff check src/ --output-format=github
      
      - name: Run type check
        run: mypy src/ --ignore-missing-imports --no-error-summary
        continue-on-error: true

  # ============== Unit Tests ==============
  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio
      
      - name: Run tests
        run: |
          pytest tests/ -v --cov=src --cov-report=xml --cov-report=term-missing
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
      
      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          fail_ci_if_error: false

  # ============== RAG Evaluation ==============
  evaluate:
    name: RAG Evaluation
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Install Promptfoo
        run: npm install -g promptfoo
      
      - name: Run Promptfoo evaluation
        run: |
          cd eval
          npx promptfoo eval -c promptfooconfig.yaml -o results/ci-eval.json --json
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
      
      - name: Upload evaluation results
        uses: actions/upload-artifact@v6
        with:
          name: eval-results
          path: eval/results/
      
      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync('eval/results/ci-eval.json'));
            
            const passed = results.results?.filter(r => r.success).length || 0;
            const total = results.results?.length || 0;
            const passRate = total > 0 ? ((passed / total) * 100).toFixed(1) : 0;
            
            const body = `## ðŸ§ª RAG Evaluation Results
            
            | Metric | Value |
            |--------|-------|
            | Tests Passed | ${passed}/${total} |
            | Pass Rate | ${passRate}% |
            
            [View full results](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  # ============== Build Check ==============
  build:
    name: Build Check
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Verify imports
        run: |
          python -c "from src.rag import RAGPipeline; print('RAG Pipeline OK')"
          python -c "from src.api.main import app; print('FastAPI OK')"
          python -c "from src.llmops import LangfuseTracer; print('LLMOps OK')"
